<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>seisaku</title>
    <link rel="stylesheet" type="text/css" href="css/seisaku.css" />
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> -->
    <!-- <a href="#" class="load-title" data-title="Title"><i class="fas fa-file"></i> Title</a> -->
    <!-- <link href=”https://use.fontawesome.com/releases/v6.0.0/css/all.css” rel=”stylesheet”> -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
</head>
<id="">

    <header id="head">

        <div id="m-room">
            <div id="p-room">
                <button class="save" onclick="downloadWord()">エクスポート</button>
                <button id="save" class="save">保存</button>
            </div>
            <div id="n-room">
                <div id="charCount">文字数: 0</div>
                <div id="lineCount">行数: 0</div>
            </div>
            <div id="o-room">
                <p>行数</p>
                <select name="" id="gyo" class="p_down"></select>
                <p>文字数/行</p>
                <select name="" id="moji" class="p_down"></select>
            </div>
        </div>
        <div id="t-heder">
            <!-- <div id=""> -->
                <p id="hashira" class="h-text">柱</p>
                <p id="togaki" class="h-text">ト書き</p>
                <p id="serihu" class="h-text">セリフ</p>
                    <div class="menu" id="menu">
                        <div>
                            <div class="b-tojo"> 
                                <p>登場人物名追加</p>
                                <p class="j-tuika">＋</p>
                            </div>
                            <div class="b-men-tuika">
                                <p class="b-men" style="display: none;">
                                    <span class="pencil-icon">▼</span>
                                    <input class="editable-text" placeholder="〇名前・場所（時刻）"></input>
                                </p>
                            </div>
                        </div>
                    </div>
            <!-- </div> -->
        
            <!-- <div id="kfk"> -->
                <p id="keika" class="h-text">時間経過</p>
                <p id="flash" class="h-text">フラッシュ</p>
                <p id="kaiso" class="h-text">回想</p>
            <!-- </div> -->
        
                <p id="NA" class="h-text">ナレーション</p>
        </div>
    </header>
 

<main id="main">

        <div id="side2">
            <div class="header-area">
                <div class="fadeIn2 show hamburger">
                    <!-- ハンバーガーメニューの線 -->
                    <span></span>
                    <span></span>
                    <span></span>
                    <!-- /ハンバーガーメニューの線 -->
                </div>
            </div>
            <ul class="slide-menu">
                <a href="http://127.0.0.1:5501/ichiran.html" target="_blank" class="k-ichiran">
                    <p class="m-title">　脚本一覧</p>
                </a>
                <p class="n-title">　新規作成</p>
                <div>
                    <p class="new-file">＋保存File</p>
                    <div class="s-box">
                        <p class="save-title"></p>
                    </div>
                </div>
            </ul>
        </div>


    <!-- <section id="t-room"> -->
        <div id="t-box">
            <textarea id="text1" cols="54" rows="30" wrap="soft" class="t-area"></textarea>
            <!-- <textarea id="text2" cols="54" rows="30" wrap="soft" class="t-area" style="display: none;"></textarea> -->
        </div>
    <!-- </section> -->

    <section id="side1">
    <div id="side">
        <div id="v-box">
            <p id="v-boxID">１</p>
            <p id="view1" class="view"></p>
        </div>
    </div> 
    </section>

</main>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/f8d91bc05f.js" crossorigin="anonymous"></script>
<script>

    // jQueryを使って編集可能なテキストにする

    $('.pencil-icon').click(function () {
        var textElement = $(this).next('.editable-text');
        textElement.attr('contenteditable', 'true').focus().addClass('editing');

        // フォーカスが外れたら編集を終了
        textElement.blur(function () {
            $(this).attr('contenteditable', 'false').removeClass('editing');
        });
    });

    $('#side1').appendTo('#main');


    // テキストエリアがクリックされた時の処理
    $("#text1").click(function () {
        $(this).addClass("focused");
    });

    // textareaの内容が変更されたら
    $("#text1").on("input", function () {
        // textareaの内容を取得してview1に表示
        $("#view1").text($(this).val());
    });

    $('.hamburger').click(function () {
        $('.hamburger, .slide-menu').toggleClass('active');
    });
    


    // 選択されたオプションのキーを定義
    const selectedGyoKey = 'selectedGyo';
    const selectedMojiKey = 'selectedMoji';

    // ページが読み込まれたときに実行される処理
    $(window).on('load', function () {
        // ローカルストレージから選択されたオプションを取得
        const selectedGyo = localStorage.getItem(selectedGyoKey);
        const selectedMoji = localStorage.getItem(selectedMojiKey);

        // 選択されたオプションを適用
        if (selectedGyo) {
            $('#gyo').val(selectedGyo);
        }
        if (selectedMoji) {
            $('#moji').val(selectedMoji);
        }

        // オプションが変更されたときに実行される処理
        $('#gyo').on('change', function () {
            // 選択されたオプションを取得してローカルストレージに保存
            const selectedValue = $(this).val();
            localStorage.setItem(selectedGyoKey, selectedValue);
        });

        $('#moji').on('change', function () {
            // 選択されたオプションを取得してローカルストレージに保存
            const selectedValue = $(this).val();
            localStorage.setItem(selectedMojiKey, selectedValue);
        });
    });
    


        function downloadWord() {
            // テキストエリアの内容を取得
            var text = document.getElementById('text1').value;

            // Blobオブジェクトを作成
            var blob = new Blob([text], { type: 'application/msword' });

            // a要素を作成
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);

            // ダウンロード時のファイル名を設定
            var filename = 'document.doc';
            a.download = filename;

            // ダウンロードリンクをクリックしてファイルをダウンロード
            a.click();
        }

        //行数と文字数を代入
        function selectBoxCreate(start, end) {
            let str = "<option value=''>--</option>";
            for (let i = start; i < end; i++) {
                str += `<option>${i}</option>`;
            }
            return str;
        }
        const gyo = selectBoxCreate(5, 41);
        const moji = selectBoxCreate(20, 51);

        $("#gyo").html(gyo);
        $("#moji").html(moji);


        // 初期値の設定
        let selectedGyo = parseInt($("#gyo").val());
        let selectedMoji = parseInt($("#moji").val());
        let bBoxCounter = 2; // 最初のtextareaの数を設定

        // ページが読み込まれたときに実行する処理
        function applySelectedValuesFromLocalStorage() {
            // ローカルストレージから選択された値を取得
            const storedGyo = localStorage.getItem("selectedGyo");
            const storedMoji = localStorage.getItem("selectedMoji");

            // 取得した値があれば適用
            if (storedGyo !== null) {
                selectedGyo = parseInt(storedGyo);
                $("#gyo").val(storedGyo);
            }
            if (storedMoji !== null) {
                selectedMoji = parseInt(storedMoji);
                $("#moji").val(storedMoji);
            }
        }

        // 初回実行
        applySelectedValuesFromLocalStorage();

        // 行数と文字数の選択ボックスから選択された値を取得
        $("#gyo").on("change", function () {
            selectedGyo = parseInt($(this).val()); // 選択された行数を整数に変換して変数に代入
            localStorage.setItem("selectedGyo", selectedGyo); // 選択された値をローカルストレージに保存
        });

        $("#moji").on("change", function () {
            selectedMoji = parseInt($(this).val()); // 選択された文字数を整数に変換して変数に代入
            localStorage.setItem("selectedMoji", selectedMoji); // 選択された値をローカルストレージに保存
        });

        // ローカルストレージの値を適用する関数
        function applyLocalStorageValues() {
            const storedTextAreas = localStorage.getItem("textAreas");
            if (storedTextAreas) {
                try {
                    const textAreas = JSON.parse(storedTextAreas);
                    textAreas.forEach(textArea => {
                        // 既存のテキストエリアが存在する場合は更新、存在しない場合は新しいテキストエリアを作成
                        const $existingTextarea = $("#" + textArea.id);
                        if ($existingTextarea.length > 0) {
                            $existingTextarea.val(textArea.value);
                            updateView($existingTextarea); // 対応する view を更新
                        } else {
                            createNewTextarea(textArea.value, textArea.id); // 新しいテキストエリアを作成
                        }
                    });
                } catch (e) {
                    console.error("Failed to parse stored text areas:", e);
                }
            }
        }



        function createNewTextarea(text) {
            // 新しいtextareaを作成
            let $newTextarea = $("<textarea>").attr({
                id: "text" + bBoxCounter,
                cols: "54",
                rows: "30",
                wrap: "soft",
                class: "t-area"
            }).val(text).on('input', function () {
                let text = $(this).val();
                // 改行文字を削除してから文字数をカウント
                let charCount = text.replace(/\n/g, '').length;
                let lines = text.split("\n");
                let lineCount = lines.length; // 行数を計算
                $("#charCount").text("文字数: " + charCount); // 文字数を表示
                $("#lineCount").text("行数: " + lineCount); // 行数を表示

                // viewに改行を反映するため、改行文字を<br>に変換
                let viewText = text.replace(/\n/g, '<br>');
                $("#view" + $newTextarea.attr("id").substr(4)).html(viewText);

                for (var i = 0; i < lines.length; i++) {
                    if (lines[i].trim().length === 0) {
                        continue;
                    }
                    if (lines[i].length > selectedMoji) {
                    // 選択された文字数を超える場合
                        // その位置に改行を挿入
                        lines[i] = lines[i].substring(0, selectedMoji) + "\n" + lines[i].substring(selectedMoji);
                    }
                }
                $(this).val(lines.join('\n'));

                // 行数が最大の行数を超える場合、超えた部分を削除する
                if (lineCount > selectedGyo) {
                    lines = lines.slice(0, selectedGyo); // 最大の行数までの行だけを残す
                }

                $(this).val(lines.join("\n")); // 文字数制限を適用したテキストを再度設定

                // 行数が制限を超えた場合、新しいtextareaを作成する
                if (lineCount > selectedGyo) {
                    createNewTextarea('');
                }

                // 対応するviewに反映
                $("#view" + $newTextarea.attr("id").substr(4)).text($(this).val());
            });

            // 新しいviewを作成
            let $newView = $("<p>").attr({
                id: "view" + bBoxCounter // 動的にidを設定します
            }).addClass("view").text(text);

            // 新しいb-boxIDを作成
            let $newBBoxID = $("<p>").attr({
                id: "v-boxID" + bBoxCounter // 動的にidを設定します
            }).text(bBoxCounter);

            // t-boxに新しいtextareaを追加
            $("#t-box").append($newTextarea);

            // v-boxに新しいviewとb-boxIDを追加
            $("#v-box").append($newBBoxID);
            $("#v-box").append($newView);

            // 新しいtextareaの表示
            $newTextarea.show();
            $newTextarea.addClass("focused");

            // text1のフォーカスを解除
            $("#text1").removeClass("focused");

            // 新しいtextareaにフォーカスを移動
            $newTextarea.focus();

            // 新しいtextareaでバックスペースを押した時に直前のtextareaにフォーカスを戻す処理
            $newTextarea.on("keydown", function (e) {
                if (e.which === 8 && $(this).val() === "") {
                    e.preventDefault();
                    let $prevTextarea = $(this).prevAll("textarea:first");
                    if ($prevTextarea.length > 0) {
                        $prevTextarea.addClass("focused");
                        $prevTextarea.focus();
                        // このtextareaを非表示にする
                        $(this).hide();
                        $(this).removeClass("focused");

                        // 対応するviewも非表示にする
                        $newView.hide();
                        $newBBoxID.hide();

                        // b-boxIDの数値を減算する
                        bBoxCounter--;

                        // 新しいtextareaとviewを削除する
                        $(this).remove();
                        $newView.remove();

                        // b-boxIDも削除する
                        $newBBoxID.remove();

                        // テキストエリアの数が1つ以下になった場合、text1にフォーカスを戻す
                        if ($("#t-box .t-area").length <= 1) {
                            $("#text1").addClass("focused");
                        }
                    }
                }
            });

            // b-boxIDの数値をインクリメント
            bBoxCounter++;
        }

        // 対応するviewを更新する関数
        function updateView($textarea) {
            let text = $textarea.val();
            let lines = text.split("\n");
            let viewText = lines.slice(0, selectedGyo).join("\n");
            let $view = $("#view" + $textarea.attr("id").substr(4));
            $view.text(viewText);
        }

        // ローカルストレージに更新内容を保存する関数
        function updateLocalStorage($textarea) {
            let textAreaId = $textarea.attr("id");
            let text = $textarea.val();
            let storedTextAreas = JSON.parse(localStorage.getItem("textAreas")) || [];
            let index = storedTextAreas.findIndex(ta => ta.id === textAreaId);

            if (index > -1) {
                storedTextAreas[index].value = text;
            } else {
                storedTextAreas.push({ id: textAreaId, value: text });
            }

            localStorage.setItem("textAreas", JSON.stringify(storedTextAreas));
        }



        $(".n-title").click(function () {
            bBoxCounter = 1;
            // すべてのテキストエリアと view を非表示にする
            $(".t-area").remove();
            $(".view").remove();

            // v-boxIDをリセット
            $("#v-box").empty();

            // 新しい空のテキストエリアを作成し、最初のテキストエリアとして表示する
            createNewTextarea('');
        });


        function createNewTextarea(text) {
            // 新しいtextareaを作成
            let $newTextarea = $("<textarea>").attr({
                id: "text" + bBoxCounter,
                cols: "54",
                rows: "30",
                wrap: "soft",
                class: "t-area"
            }).val(text).on('input', function () {
                let text = $(this).val();
                let charCount = text.replace(/\n/g, '').length;
                let lines = text.split("\n");
                let lineCount = lines.length;
                $("#charCount").text("文字数: " + charCount);
                $("#lineCount").text("行数: " + lineCount);

                // viewに改行を反映するため、改行文字を<br>に変換
                let viewText = text.replace(/\n/g, '<br>');
                $("#view" + $newTextarea.attr("id").substr(4)).html(viewText);

                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].trim().length === 0) {
                        continue;
                    }
                    if (lines[i].length > selectedMoji) {
                        lines[i] = lines[i].substring(0, selectedMoji) + "\n" + lines[i].substring(selectedMoji);
                    }
                }
                $(this).val(lines.join('\n'));

                if (lineCount > selectedGyo) {
                    lines = lines.slice(0, selectedGyo);
                }

                $(this).val(lines.join("\n"));

                if (lineCount > selectedGyo) {
                    createNewTextarea('');
                }

                $("#view" + $newTextarea.attr("id").substr(4)).text($(this).val());

                $(document).on("keydown", "textarea", function (e) {
                    if (e.which === 37) { // 左矢印キーの場合
                        // カーソルがテキストの最後にある場合は、直後のtextareaにフォーカスを移動します
                        if (this.selectionEnd === this.value.length) {
                            let $nextTextarea = $(this).nextAll("textarea:first");
                            if ($nextTextarea.length > 0) {
                                $nextTextarea.addClass("focused");
                                $nextTextarea.focus();
                                e.preventDefault(); // デフォルトの動作を防止
                            }
                        }
                    }
                    if (e.which === 39) { // 右矢印キーの場合
                        // カーソルがテキストの先頭にある場合は、直前のtextareaにフォーカスを移動します
                        if (this.selectionStart === 0) {
                            let $prevTextarea = $(this).prevAll("textarea:first");
                            if ($prevTextarea.length > 0) {
                                $prevTextarea.addClass("focused");
                                $prevTextarea.focus();
                                e.preventDefault(); // デフォルトの動作を防止
                            }
                        }
                    }
                });


            });

            // 新しいviewを作成
            let $newView = $("<p>").attr({
                id: "view" + bBoxCounter
            }).addClass("view").text(text);

            // 新しいb-boxIDを作成
            let $newBBoxID = $("<p>").attr({
                id: "v-boxID" + bBoxCounter
            }).text(bBoxCounter);

            // t-boxに新しいtextareaを追加
            $("#t-box").append($newTextarea);

            // v-boxに新しいviewとb-boxIDを追加
            $("#v-box").append($newBBoxID);
            $("#v-box").append($newView);

            $newTextarea.show();
            $newTextarea.addClass("focused");

            $("#text1").removeClass("focused");

            $newTextarea.focus();

            $newTextarea.on("keydown", function (e) {
                if (e.which === 8 && $(this).val() === "") {
                    e.preventDefault();
                    let $prevTextarea = $(this).prevAll("textarea:first");
                    if ($prevTextarea.length > 0) {
                        $prevTextarea.addClass("focused");
                        $prevTextarea.focus();
                        $(this).hide();
                        $(this).removeClass("focused");
                        $newView.hide();
                        $newBBoxID.hide();
                        bBoxCounter--;
                        $(this).remove();
                        $newView.remove();
                        $newBBoxID.remove();
                        if ($("#t-box .t-area").length <= 1) {
                            $("#text1").addClass("focused");
                        }
                    }
                }
            });

            bBoxCounter++;
        }



        // 保存Fileをクリックした時の処理
        $(".new-file").click(function () {
            // save-titleの表示・非表示を切り替える
            $(".save-title").toggle();
        });

        // 保存されたタイトルをロードして表示する処理
        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            try {
                let data = JSON.parse(localStorage.getItem(key));
                if (data && data.title) {
                    $(".save-title").append('<div><a href="#" class="load-title" data-title="' + data.title + '">' + data.title + '</a></div>');
                }
            } catch (e) {
                console.error("Failed to parse saved data:", e);
            }
        }


        
    
            // 保存ボタンがクリックされた時の処理
            $("#save").on("click", function () {
                let currentTitle = $(".save-title").data("currentTitle");
                let title = prompt("保存するタイトルを入力してください:", currentTitle ? currentTitle : "");

                if (title) {
                    if (localStorage.getItem(title) && title !== currentTitle) {
                        if (confirm("このタイトルは既に存在します。上書き保存しますか？")) {
                            saveData(title);
                            alert("上書き保存しました");
                        } else {
                            alert("上書き保存をキャンセルしました");
                        }
                    } else {
                        saveData(title);
                        alert("保存しました");
                        // 新規保存の場合のみタイトルをリンクとして追加
                        if (title !== currentTitle) {
                            $(".save-title").append('<div><a href="#" class="load-title" data-title="' + title + '">' + title + '</a></div>');
                        }
                    }
                } else {
                    alert("タイトルを入力してください。");
                }
            });



            // タイトルリンクがクリックされた時の処理
            $(document).on("click", ".load-title", function (e) {
                e.preventDefault();
                let title = $(this).data("title");
                let savedData = localStorage.getItem(title);

                if (savedData) {
                    try {
                        let parsedData = JSON.parse(savedData);
                        let textAreas = parsedData.textAreas;

                        // v-box内の要素をクリア
                        $("#v-box").empty();
                        $(".t-area").remove();

                        // bBoxCounterをリセット
                        bBoxCounter = 1;

                        // 保存されたテキストエリアを復元
                        textAreas.forEach(textArea => {
                            createNewTextarea(textArea.value);
                        });

                        $(".save-title").data("currentTitle", title); // 現在のタイトルを設定
                        alert("データが復元されました");
                    } catch (e) {
                        console.error("Failed to parse saved data:", e);
                        alert("データの読み込みに失敗しました。");
                    }
                } else {
                    alert("保存されたデータが見つかりません。");
                }
            });

            function saveData(title) {
                let textAreas = [];
                $(".t-area").each(function () {
                    let textAreaObj = {
                        id: $(this).attr("id"),
                        value: $(this).val()
                    };
                    textAreas.push(textAreaObj);
                });

                let dataToSave = {
                    title: title,
                    textAreas: textAreas
                };

                localStorage.setItem(title, JSON.stringify(dataToSave));
                $(".save-title").data("currentTitle", title); // 現在のタイトルを保存
            }


        // 初回実行
        applyLocalStorageValues();

        // 最初のテキストエリアに対するイベントハンドラを追加
        $("#text1").on("input", function () {
            let text = $(this).val();
            let charCount = text.replace(/\n/g, '').length;
            let lines = text.split("\n");
            let lineCount = lines.length;
            $("#charCount").text("文字数: " + charCount);
            $("#lineCount").text("行数: " + lineCount);
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].length > selectedMoji) {
                    lines[i] = lines[i].substring(0, selectedMoji) + "\n" + lines[i].substring(selectedMoji);
                }
            }
            if (lineCount > selectedGyo) {
                lines = lines.slice(0, selectedGyo);
            }

            $(this).val(lines.join("\n"));

            if (lineCount > selectedGyo) {
                createNewTextarea('');
            }

            updateView($(this));
            updateLocalStorage($(this));
        });


        // // 初回実行
        // applyLocalStorageValues();

    $(document).ready(function () {

        // 初期値の設定
        let selectedGyo = parseInt($("#gyo").val());
        let selectedMoji = parseInt($("#moji").val());
        let bBoxCounter = 2; // 最初のtextareaの数を設定

        // ページが読み込まれたときに実行する処理
        function applySelectedValuesFromLocalStorage() {
            // ローカルストレージから選択された値を取得
            const storedGyo = localStorage.getItem("selectedGyo");
            const storedMoji = localStorage.getItem("selectedMoji");

            // 取得した値があれば適用
            if (storedGyo !== null) {
                selectedGyo = parseInt(storedGyo);
                $("#gyo").val(storedGyo);
            }
            if (storedMoji !== null) {
                selectedMoji = parseInt(storedMoji);
                $("#moji").val(storedMoji);
            }
        }

        // 初回実行
        applySelectedValuesFromLocalStorage();

        // 行数と文字数の選択ボックスから選択された値を取得
        $("#gyo").on("change", function () {
            selectedGyo = parseInt($(this).val()); // 選択された行数を整数に変換して変数に代入
            localStorage.setItem("selectedGyo", selectedGyo); // 選択された値をローカルストレージに保存
        });

        $("#moji").on("change", function () {
            selectedMoji = parseInt($(this).val()); // 選択された文字数を整数に変換して変数に代入
            localStorage.setItem("selectedMoji", selectedMoji); // 選択された値をローカルストレージに保存
        });

        // テキストエリアの追加機能の実装
        function createNewTextarea(text) {
            // 新しいテキストエリアを作成する処理
            // ここに実装を追加
        }

        // テキストエリアの内容を更新するための関数
        function updateView(textarea) {
            let text = textarea.val();
            let lines = text.split("\n");
            let charCount = text.replace(/\n/g, '').length;
            let lineCount = lines.length;

            // 文字数と行数を更新する
            $("#charCount").text("文字数: " + charCount);
            $("#lineCount").text("行数: " + lineCount);

            // 選択された行数と文字数に基づいて、テキストを修正する
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].length > selectedMoji) {
                    lines[i] = lines[i].substring(0, selectedMoji) + "\n" + lines[i].substring(selectedMoji);
                }
            }
            if (lineCount > selectedGyo) {
                lines = lines.slice(0, selectedGyo);
            }

            textarea.val(lines.join("\n"));
        }

        // 最初のテキストエリアに対するイベントハンドラを追加
        $("#text1").on("input", function () {
            let text = $(this).val();
            let charCount = text.replace(/\n/g, '').length;
            let lines = text.split("\n");
            let lineCount = lines.length;
            $("#charCount").text("文字数: " + charCount);
            $("#lineCount").text("行数: " + lineCount);

            // 文字数と行数に基づいて、テキストを修正する
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].length > selectedMoji) {
                    lines[i] = lines[i].substring(0, selectedMoji) + "\n" + lines[i].substring(selectedMoji);
                }
            }
            if (lineCount > selectedGyo) {
                lines = lines.slice(0, selectedGyo);
            }

            $(this).val(lines.join("\n"));

            // 新しいテキストエリアを作成する条件を追加する
            if (lineCount > selectedGyo) {
                createNewTextarea('');
            }

            // テキストエリアのビューを更新する
            updateView($(this));
        });
    });




            // サイドバー内のビュー要素がクリックされた時の処理
            $('#side').on('click', '.view', function () {
                // クリックされたビューのIDを取得
                var viewId = $(this).attr('id');

                // テキストエリアのIDはビューのIDから'view'を削除して'text'に変更する
                var textareaId = viewId.replace('view', 'text');

                // 対応するテキストエリアを取得し、そのテキストエリアにフォーカスを移動
                $('#' + textareaId).focus();
            });

            // サイドバー内のカーソル要素がクリックされた時の処理
            $('#side').on('click', '.cursor', function () {
                // クリックされたカーソル要素の親要素のスクロール位置を取得
                var scrollTop = $('#side').scrollTop(); // 修正箇所

                // カーソルの方向に応じてスクロールする量を決定
                var scrollAmount = ($(this).hasClass('up') ? -50 : 50);

                // スクロール位置を調整して更新
                $('#side').scrollTop(scrollTop + scrollAmount);
            });



            // 各ボタンのクリックイベントをまとめる
            $(document).on('click', '#hashira, #togaki, #flash, #keika, #kaiso, #NA', function () {
                let $focusedTextArea = $('textarea.focused');

                // フォーカスされたテキストエリアが存在するか確認
                if ($focusedTextArea.length > 0) {
                    let $textArea = $focusedTextArea.eq(0); // フォーカスされた最初のテキストエリアを取得
                    let startPos = $textArea[0].selectionStart; // カーソルの開始位置を取得
                    let endPos = $textArea[0].selectionEnd; // カーソルの終了位置を取得
                    let text = $textArea.val();
                    let newText = "";

                    // 各ボタンによって挿入する文字列を変更
                    if ($(this).attr('id') === 'hashira') {
                        newText = text.substring(0, startPos) + "〇場所（時間）" + text.substring(endPos, text.length);
                    } else if ($(this).attr('id') === 'togaki') {
                        newText = text.substring(0, startPos) + "　　　" + text.substring(endPos, text.length);
                    } else if ($(this).attr('id') === 'flash') {
                        newText = text.substring(0, startPos) + "　　　×　　×　　×（フラッシュ）\n" + text.substring(endPos, text.length);
                    } else if ($(this).attr('id') === 'keika') {
                        newText = text.substring(0, startPos) + "　　　×　　×　　×\n" + text.substring(endPos, text.length);
                    } else if ($(this).attr('id') === 'kaiso') {
                        newText = text.substring(0, startPos) + "〇回想・場所（時期・時間）\n\n　　　回想終わり。" + text.substring(endPos, text.length);
                    } else if ($(this).attr('id') === 'NA') {
                        newText = text.substring(0, startPos) + "〇名前NA『』" + text.substring(endPos, text.length);
                    }

                    // 文字列を挿入
                    $textArea.val(newText);

                    // テキストエリアにフォーカスを戻す
                    $textArea[0].focus();

                }
            });

            // テキストエリアがクリックされた時の処理
            $(document).on('click', 'textarea', function () {
                // すべてのテキストエリアからフォーカスを外す
                $('textarea').removeClass('focused');
                // クリックされたテキストエリアにフォーカスを設定する
                $(this).addClass('focused');
            });



        // セリフをクリックしたときの処理
        $('#serihu').click(function () {
            // メニューの表示を切り替える
            $('#menu').toggle();
        });

        // #main をクリックしたときの処理
        $('#main').on('click', function (event) {
            if (!$(event.target).closest('#menu').length) {
                // メニュー以外をクリックした場合、メニューを非表示にする
                $('.menu').hide();
            }
        });



    // editable-text をクリックしたときの処理
    $(document).on('click', '.editable-text', function () {
        // 編集可能にする
        $(this).attr('contenteditable', 'true');
        $(this).focus();
    });


    
    $(document).on('click', '.pencil-icon', function () {
        // editable-text に入力された文字列を取得
        let insertText = $(this).siblings('.editable-text').text();
        // フォーカスされたテキストエリアに挿入する
        let $focusedTextArea = $('textarea.focused');
        if ($focusedTextArea.length > 0) {
            let $textArea = $focusedTextArea.eq(0); // フォーカスされた最初のテキストエリアを取得
            let startPos = $textArea[0].selectionStart; // カーソルの開始位置を取得
            let endPos = $textArea[0].selectionEnd; // カーソルの終了位置を取得
            let text = $textArea.val();
            let newText = text.substring(0, startPos) + insertText + text.substring(endPos, text.length);

            // 文字列を挿入
            $textArea.val(newText);

            // テキストエリアにフォーカスを戻す
            $textArea[0].focus();
        }
    });

     // j-tuika をクリックしたときの処理
        $('.j-tuika').click(function () {
            // 新しい b-men 要素を作成
            var $newBmen = $('<p class="b-men">' +
                '<span class="pencil-icon">▼</span>' +
                '<input class="editable-text" placeholder="〇名前・場所（時刻）"></input>' +
                '</p>');

            // b-tojo の直後に追加する
            $('.b-tojo').after($newBmen);
        });


        
    </script>


</body>

</html>